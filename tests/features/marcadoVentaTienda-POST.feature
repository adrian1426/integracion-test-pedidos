Feature: /pedidos POST - Generar pedido

  Realiza el Marcado de la Venta

  Scenario: Negocio un consumer key y secret key de la app de prueba

    Given I have basic authentication credentials `apigeeUsername` and `apigeePassword`
    And I have valid client TLS configuration

    When I GET `apigeeHost`/v1/organizations/`apigeeOrg`/developers/`apigeeDeveloper`/apps/`apigeeApp`

    Then response code should be 200
    And response body should be valid json
    And I store the value of body path $.credentials[0].consumerKey as globalConsumerKey in global scope
    And I store the value of body path $.credentials[0].consumerSecret as globalConsumerSecret in global scope

  Scenario: Negocia un access token con el Authorization server

    Given I set form parameters to
      | parameter  | value              |
      | grant_type | client_credentials |

    And I have basic authentication credentials `globalConsumerKey` and `globalConsumerSecret`
    And I have valid client TLS configuration

    When I POST to `apigeeDomain`/`apigeeOauthEndpoint`

    Then response code should be 200
    And response body should be valid json
    And I store the value of body path $.access_token as access token

  Scenario: /pedidos 201 Se genera pedido.

    Given I set Content-Type header to application/json
    And I set bearer token
    And I have valid client TLS configuration
    And I set body to {"folioPresupuesto":863167, "referencia":"VentaServicioWeb","caja":[{"importe":8771,"idTipoPago":"1","idReferencia":1}],"elektraComercio":{"detalleOrden":{"idOrigenVenta":2,"tienda":4624,"canal":1,"idEstado":0,"negocioTipoVenta":"7777","descripcionNegocioTipoVenta":"Venta Elektra.com","ventaEmpleado":false,"solicitudCredito":false,"tipoValidacionPedido":"cat. ext","estadoDescripcion":"Ok","datosCliente":{"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","fechaNacimiento":"17-02-1989","idEstadoCivil":1,"idSexo":1,"numeroRFC":"XAXX010101000","fisicaMoral":"fisico","calle":"AV. RIO NILO No. 77100","numeroExterior":"230","numeroInterior":"A-236","codigoPostal":14000,"colonia":"BOSQUES DE TONALA","telefono":"3323670854","empleado":"T1002563"},"factura":{"requiereFactura":true,"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","calleNumero":"77100","numeroExterior":"230","numeroInterior":"A-236","colonia":"BOSQUES DE TONALA","codigoPostal":14000,"estado":"CDMX","ciudad":"CDMX","telefono":"3323670854","numeroRFC":"XAXX010101000"},"beneficiario1":"Elvia","beneficiario2":"Elvia","imprimirVoucher":true,"solicitarHuella":false,"tarjetaCompra":{"numeroPedido":"v29908800ekt-01","fecha":"05\/11\/2020","hora":"14:10:25","nombreTarjetaHabiente":"Elvia Morales","numeroTarjeta":"**** **** **** 0000","folioAutorizacion":"804537571","importePedido":"829.0000","numeroAfiliacion":"2565401","bancoAdquirente":"Venta en Linea Elektra.com","terminosCondiciones":"Recibí por parte de Tienda Elektra la mercancía relacionada al número de pedido","terminosCondiciones2":"Nombre y firma de la persona que recibe","terminosCondiciones3":"Para cualquier aclaración o cancelación por favor proporcione el número del pedido generado en tienda; indicado en la parte superior de este comprobante"},"imprimeVoucherOrden":true,"ordenVoucher":{"numeroTienda":4624,"numeroDeSocio":0,"adquiridor":"ekt","bancoEmisorTarjetaTransaccion":"BBVA","marcaTarjetaTransaccion":2,"tipoTarjetaTransaccion":1,"numeroTarjetaTransaccion":"A7348553359B4ABE9ABC327BBF608D99","numeroTarjetaTransaccionEnMascarada":"xxxxxxxxxxxxxxxxxxxxxxxxxxxx8D99","fechaHoraVencimientoTarjetaTransaccion":"05-11-2020 11:52:03","montoTransaccion":829,"fechaHoraTransaccion":"05/11/2020 11:52:03","tiempoTransaccion":"00:00:30","numeroAutorizacionPAZ":"804537571","numeroReferenciaPAZ":"213654","codigoECI":"c5446","codigoISO":"16516","codigoRespuestaPAZ":{"llave":0,"valor":"Aprobada"}},"estacionTrabajo":"GERENTE","tipoUsuario":"T146363","ventas":[{"subPartidas":"0","tipoProveedor":"v-25","cantidad":1,"costoProducto":100,"descuento":0,"milenias":[{"sku":1002522,"sobrePrecio":5}],"promociones":[{"id":5555,"idTipo":10,"idSubTipo":20,"cantidad":1,"idRegalo":12,"monto":5}],"mecanica":0,"precio":112,"sku":1002520,"sobrePrecio":0,"descuentoEspecial":0}],"referencia":"v26864600ekt-V","idTipoVenta":1,"totalVenta":31999,"pago":{"idTipo":2,"mesesSinIntereses":12,"idBanco":"14","numeroTarjeta":"C4772143013277427","referencia":"124520","monto":110,"idCanal":1,"numeroPagos":12},"consecutivoPedido":1,"costoEstimado":0,"idTipoEntrega":1,"proveedorEnvio":"MarketplaceGenerico","idOmnicanal":3,"totalPedidos":2,"afectaContabilidad":false,"idMercado":1,"montoVentaMP":0,"montoComision":0,"idPenalizacion":0,"montoPenalizacion":0,"idOrigenEnvio":22,"otorgaRegalo":false,"skuOtorgaRegalo":1002510,"evitaSuministro":false,"idNegocio":12,"idPaqueteria":22,"idTiendaSurte":4624,"idProveedor":999999,"proveedorEnvioDirecto":false,"ordenDistribucion":292907,"notaCargo":"4860246","numeroFactura":"DS154554","idOrden":"v31485575ekt-01","fechaHoraSuministro":"2021-01-07 10:34:11","urlRastreo":"https://www.dhl.com/mx-es/home/rastreo.html","idCodigoSurtimiento":139,"gastosAdicionales":[{"monto":0,"id":1}],"guia":"EKT000000000041502","paqueteria":"ektnvia","idPedidoAdn":0,"notaDebito":[{"id":775049,"destinatario":"Miguel Ruiz","numeroRastreo":"000000000588270","idAlmacen":139}]},"cliente":{"apellidoMaterno":"Castellanos","apellidoPaterno":"Montesinos","nombre":"Paola","correoElectronico":"cmontesinos@mail.com","domicilio":{"id":"38c8395027e140909bd23fcdcdf831ba","tipo":"residential","destinatario":"Claudia Pérez","codigoPostal":"09704","ciudad":"Iztapalapa","estado":"DISTRITO FEDERAL","pais":"MEX","calle":"José Clemente Orozco","numero":48,"delegacion":"Degollado","complemento":"piso 2","referencia":"casa azul, portón gris"}}}}
    When I POST to `apigeeDomain`/elektra/comercio/`deploymentSuffix`/pedidos

    Then response code should be 201
    And response body should be valid json
    And response body path $.codigo should be ([A-Za-z])+.\w+
    And response body path $.mensaje should be ([A-Za-z])+.\w+
    And response body path $.folio should be ^[A-z-0-9]{0,}$
    And response body path $.resultado.numeroTransaccion should be ^([0-9])*$
    And response body path $.resultado.permitirSurtimiento should be ^(?:tru|fals)e$
    And response body path $.resultado.detalleOperacion should be [a-zA-Z\t\h]+|(^$)

  Scenario: /pedidos 400 bad request.

    Given I set Content-Type header to application/json
    And I set bearer token
    And I have valid client TLS configuration
    And I set body to {"folioPresupuesto":null, "referencia":"VentaServicioWeb","caja":[{"importe":8771,"idTipoPago":"1","idReferencia":1}],"elektraComercio":{"detalleOrden":{"idOrigenVenta":2,"tienda":4624,"canal":1,"idEstado":0,"negocioTipoVenta":"7777","descripcionNegocioTipoVenta":"Venta Elektra.com","ventaEmpleado":false,"solicitudCredito":false,"tipoValidacionPedido":"cat. ext","estadoDescripcion":"Ok","datosCliente":{"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","fechaNacimiento":"17-02-1989","idEstadoCivil":1,"idSexo":1,"numeroRFC":"XAXX010101000","fisicaMoral":"fisico","calle":"AV. RIO NILO No. 77100","numeroExterior":"230","numeroInterior":"A-236","codigoPostal":14000,"colonia":"BOSQUES DE TONALA","telefono":"3323670854","empleado":"T1002563"},"factura":{"requiereFactura":true,"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","calleNumero":"77100","numeroExterior":"230","numeroInterior":"A-236","colonia":"BOSQUES DE TONALA","codigoPostal":14000,"estado":"CDMX","ciudad":"CDMX","telefono":"3323670854","numeroRFC":"XAXX010101000"},"beneficiario1":"Elvia","beneficiario2":"Elvia","imprimirVoucher":true,"solicitarHuella":false,"tarjetaCompra":{"numeroPedido":"v29908800ekt-01","fecha":"05\/11\/2020","hora":"14:10:25","nombreTarjetaHabiente":"Elvia Morales","numeroTarjeta":"**** **** **** 0000","folioAutorizacion":"804537571","importePedido":"829.0000","numeroAfiliacion":"2565401","bancoAdquirente":"Venta en Linea Elektra.com","terminosCondiciones":"Recibí por parte de Tienda Elektra la mercancía relacionada al número de pedido","terminosCondiciones2":"Nombre y firma de la persona que recibe","terminosCondiciones3":"Para cualquier aclaración o cancelación por favor proporcione el número del pedido generado en tienda; indicado en la parte superior de este comprobante"},"imprimeVoucherOrden":true,"ordenVoucher":{"numeroTienda":4624,"numeroDeSocio":0,"adquiridor":"ekt","bancoEmisorTarjetaTransaccion":"BBVA","marcaTarjetaTransaccion":2,"tipoTarjetaTransaccion":1,"numeroTarjetaTransaccion":"A7348553359B4ABE9ABC327BBF608D99","numeroTarjetaTransaccionEnMascarada":"xxxxxxxxxxxxxxxxxxxxxxxxxxxx8D99","fechaHoraVencimientoTarjetaTransaccion":"05-11-2020 11:52:03","montoTransaccion":829,"fechaHoraTransaccion":"05/11/2020 11:52:03","tiempoTransaccion":"00:00:30","numeroAutorizacionPAZ":"804537571","numeroReferenciaPAZ":"213654","codigoECI":"c5446","codigoISO":"16516","codigoRespuestaPAZ":{"llave":0,"valor":"Aprobada"}},"estacionTrabajo":"GERENTE","tipoUsuario":"T146363","ventas":[{"subPartidas":"0","tipoProveedor":"v-25","cantidad":1,"costoProducto":100,"descuento":0,"milenias":[{"sku":1002522,"sobrePrecio":5}],"promociones":[{"id":5555,"idTipo":10,"idSubTipo":20,"cantidad":1,"idRegalo":12,"monto":5}],"mecanica":0,"precio":112,"sku":1002520,"sobrePrecio":0,"descuentoEspecial":0}],"referencia":"v26864600ekt-V","idTipoVenta":1,"totalVenta":31999,"pago":{"idTipo":2,"mesesSinIntereses":12,"idBanco":"14","numeroTarjeta":"C4772143013277427","referencia":"124520","monto":110,"idCanal":1,"numeroPagos":12},"consecutivoPedido":1,"costoEstimado":0,"idTipoEntrega":1,"proveedorEnvio":"MarketplaceGenerico","idOmnicanal":3,"totalPedidos":2,"afectaContabilidad":false,"idMercado":1,"montoVentaMP":0,"montoComision":0,"idPenalizacion":0,"montoPenalizacion":0,"idOrigenEnvio":22,"otorgaRegalo":false,"skuOtorgaRegalo":1002510,"evitaSuministro":false,"idNegocio":12,"idPaqueteria":22,"idTiendaSurte":4624,"idProveedor":999999,"proveedorEnvioDirecto":false,"ordenDistribucion":292907,"notaCargo":"4860246","numeroFactura":"DS154554","idOrden":"v31485575ekt-01","fechaHoraSuministro":"2021-01-07 10:34:11","urlRastreo":"https://www.dhl.com/mx-es/home/rastreo.html","idCodigoSurtimiento":139,"gastosAdicionales":[{"monto":0,"id":1}],"guia":"EKT000000000041502","paqueteria":"ektnvia","idPedidoAdn":0,"notaDebito":[{"id":775049,"destinatario":"Miguel Ruiz","numeroRastreo":"000000000588270","idAlmacen":139}]},"cliente":{"apellidoMaterno":"Castellanos","apellidoPaterno":"Montesinos","nombre":"Paola","correoElectronico":"cmontesinos@mail.com","domicilio":{"id":"38c8395027e140909bd23fcdcdf831ba","tipo":"residential","destinatario":"Claudia Pérez","codigoPostal":"09704","ciudad":"Iztapalapa","estado":"DISTRITO FEDERAL","pais":"MEX","calle":"José Clemente Orozco","numero":48,"delegacion":"Degollado","complemento":"piso 2","referencia":"casa azul, portón gris"}}}}
    When I POST to `apigeeDomain`/elektra/comercio/`deploymentSuffix`/pedidos

    Then response code should be 400
    And response body should be valid json
    And response body path $.codigo should be ^400\.Elektra-comercio-Pedidos\.\d{4}$
    And response body path $.mensaje should be ([A-Za-z])+.\w+
    And response body path $.folio should be ^[A-z-0-9]{0,}$
    And response body path $.info should be ^https:\/\/baz-developer\.bancoazteca\.com\.mx\/\w{4,6}#400\.Elektra-comercio-Pedidos\.\d{0,}|[A-Z]{0,}\d{0,}$
    And response body path $.detalles[*] should be ([A-Za-z])+.\w+


  Scenario: /pedidos 500 internal server error.

    Given I set Content-Type header to application/json
    And I set bearer token
    And I have valid client TLS configuration
    And I set body to {"folioPresupuesto":null, "referencia":null,"caja":[{"importe":8771,"idTipoPago":"1","idReferencia":1}],"elektraComercio":{"detalleOrden":{"idOrigenVenta":2,"tienda":4624,"canal":1,"idEstado":0,"negocioTipoVenta":"7777","descripcionNegocioTipoVenta":"Venta Elektra.com","ventaEmpleado":false,"solicitudCredito":false,"tipoValidacionPedido":"cat. ext","estadoDescripcion":"Ok","datosCliente":{"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","fechaNacimiento":"17-02-1989","idEstadoCivil":1,"idSexo":1,"numeroRFC":"XAXX010101000","fisicaMoral":"fisico","calle":"AV. RIO NILO No. 77100","numeroExterior":"230","numeroInterior":"A-236","codigoPostal":14000,"colonia":"BOSQUES DE TONALA","telefono":"3323670854","empleado":"T1002563"},"factura":{"requiereFactura":true,"nombre":"Elvia","apellidoPaterno":"Morales","apellidoMaterno":"Garcia","calleNumero":"77100","numeroExterior":"230","numeroInterior":"A-236","colonia":"BOSQUES DE TONALA","codigoPostal":14000,"estado":"CDMX","ciudad":"CDMX","telefono":"3323670854","numeroRFC":"XAXX010101000"},"beneficiario1":"Elvia","beneficiario2":"Elvia","imprimirVoucher":true,"solicitarHuella":false,"tarjetaCompra":{"numeroPedido":"v29908800ekt-01","fecha":"05\/11\/2020","hora":"14:10:25","nombreTarjetaHabiente":"Elvia Morales","numeroTarjeta":"**** **** **** 0000","folioAutorizacion":"804537571","importePedido":"829.0000","numeroAfiliacion":"2565401","bancoAdquirente":"Venta en Linea Elektra.com","terminosCondiciones":"Recibí por parte de Tienda Elektra la mercancía relacionada al número de pedido","terminosCondiciones2":"Nombre y firma de la persona que recibe","terminosCondiciones3":"Para cualquier aclaración o cancelación por favor proporcione el número del pedido generado en tienda; indicado en la parte superior de este comprobante"},"imprimeVoucherOrden":true,"ordenVoucher":{"numeroTienda":4624,"numeroDeSocio":0,"adquiridor":"ekt","bancoEmisorTarjetaTransaccion":"BBVA","marcaTarjetaTransaccion":2,"tipoTarjetaTransaccion":1,"numeroTarjetaTransaccion":"A7348553359B4ABE9ABC327BBF608D99","numeroTarjetaTransaccionEnMascarada":"xxxxxxxxxxxxxxxxxxxxxxxxxxxx8D99","fechaHoraVencimientoTarjetaTransaccion":"05-11-2020 11:52:03","montoTransaccion":829,"fechaHoraTransaccion":"05/11/2020 11:52:03","tiempoTransaccion":"00:00:30","numeroAutorizacionPAZ":"804537571","numeroReferenciaPAZ":"213654","codigoECI":"c5446","codigoISO":"16516","codigoRespuestaPAZ":{"llave":0,"valor":"Aprobada"}},"estacionTrabajo":"GERENTE","tipoUsuario":"T146363","ventas":[{"subPartidas":"0","tipoProveedor":"v-25","cantidad":1,"costoProducto":100,"descuento":0,"milenias":[{"sku":1002522,"sobrePrecio":5}],"promociones":[{"id":5555,"idTipo":10,"idSubTipo":20,"cantidad":1,"idRegalo":12,"monto":5}],"mecanica":0,"precio":112,"sku":1002520,"sobrePrecio":0,"descuentoEspecial":0}],"referencia":"v26864600ekt-V","idTipoVenta":1,"totalVenta":31999,"pago":{"idTipo":2,"mesesSinIntereses":12,"idBanco":"14","numeroTarjeta":"C4772143013277427","referencia":"124520","monto":110,"idCanal":1,"numeroPagos":12},"consecutivoPedido":1,"costoEstimado":0,"idTipoEntrega":1,"proveedorEnvio":"MarketplaceGenerico","idOmnicanal":3,"totalPedidos":2,"afectaContabilidad":false,"idMercado":1,"montoVentaMP":0,"montoComision":0,"idPenalizacion":0,"montoPenalizacion":0,"idOrigenEnvio":22,"otorgaRegalo":false,"skuOtorgaRegalo":1002510,"evitaSuministro":false,"idNegocio":12,"idPaqueteria":22,"idTiendaSurte":4624,"idProveedor":999999,"proveedorEnvioDirecto":false,"ordenDistribucion":292907,"notaCargo":"4860246","numeroFactura":"DS154554","idOrden":"v31485575ekt-01","fechaHoraSuministro":"2021-01-07 10:34:11","urlRastreo":"https://www.dhl.com/mx-es/home/rastreo.html","idCodigoSurtimiento":139,"gastosAdicionales":[{"monto":0,"id":1}],"guia":"EKT000000000041502","paqueteria":"ektnvia","idPedidoAdn":0,"notaDebito":[{"id":775049,"destinatario":"Miguel Ruiz","numeroRastreo":"000000000588270","idAlmacen":139}]},"cliente":{"apellidoMaterno":"Castellanos","apellidoPaterno":"Montesinos","nombre":"Paola","correoElectronico":"cmontesinos@mail.com","domicilio":{"id":"38c8395027e140909bd23fcdcdf831ba","tipo":"residential","destinatario":"Claudia Pérez","codigoPostal":"09704","ciudad":"Iztapalapa","estado":"DISTRITO FEDERAL","pais":"MEX","calle":"José Clemente Orozco","numero":48,"delegacion":"Degollado","complemento":"piso 2","referencia":"casa azul, portón gris"}}}}
    When I POST to `apigeeDomain`/elektra/comercio/`deploymentSuffix`/pedidos

    Then response code should be 500
    And response body should be valid json
    And response body path $.codigo should be ^500\.Elektra-comercio-Pedidos\.\d{4}$
    And response body path $.mensaje should be ([A-Za-z])+.\w+
    And response body path $.folio should be ^[A-z-0-9]{0,}$
    And response body path $.info should be ^https:\/\/baz-developer\.bancoazteca\.com\.mx\/\w{4,6}#500\.Elektra-comercio-Pedidos\.\d{0,}|[A-Z]{0,}\d{0,}$
    And response body path $.detalles[*] should be ([A-Za-z])+.\w+